name: tailscalerdp1

on:
  workflow_dispatch:
    inputs:
      choice:
        description: "Enter your choice"
        required: true
        default: "1"

jobs:
  setup-rdp:
    runs-on: windows-latest
    env:
      RDP_USER: RDP
      RDP_CREDS: ${{ secrets.RDP_PASSWORD }}
      TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure Core RDP Settings
        run: |
          Write-Host "Configuring core RDP settings..."
          # Add your RDP configuration commands here

      - name: Create RDP User with Secure Password
        run: |
          Write-Host "Creating RDP user with secure password..."
          $password = ConvertTo-SecureString $env:RDP_CREDS -AsPlainText -Force
          New-LocalUser -Name $env:RDP_USER -Password $password -FullName "RDP User" -Description "User for RDP access"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $env:RDP_USER

      - name: Install Tailscale
        run: |
          Write-Host "Installing Tailscale..."
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-ipn-setup.exe" -OutFile "$env:TEMP\tailscale-setup.exe"
          Start-Process -FilePath "$env:TEMP\tailscale-setup.exe" -ArgumentList "/quiet" -Wait

      - name: Establish Tailscale Connection
        run: |
          Write-Host "Starting Tailscale service and authenticating..."
          Start-Service -Name Tailscale
          tailscale up --authkey $env:TAILSCALE_AUTHKEY --accept-routes

      - name: Verify RDP Accessibility
        run: |
          Write-Host "Tailscale IP: $env:TAILSCALE_IP"
          Write-Host "=== RDP ACCESS ==="
          Write-Host "Address: $env:TAILSCALE_IP"
          Write-Host "Username: $env:RDP_USER"
          Write-Host "Password: $(echo $env:RDP_CREDS)"
          Write-Host "=================="

      - name: Keep runner active indefinitely
        run: |
          while ($true) {
            Write-Host "[$(Get-Date)] RDP Active - Use Ctrl+C in workflow to terminate"
            Start-Sleep -Seconds 300
          }

